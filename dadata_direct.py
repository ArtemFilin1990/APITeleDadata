"""–ü—Ä—è–º–æ–π –∑–∞–ø—Ä–æ—Å –∫ DaData findById/party –∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞.\n\n"""\n\nfrom __future__ import annotations\n\nimport asyncio\nimport html\nimport logging\nfrom datetime import datetime\n\nfrom cache import TTLCache\nfrom config import DADATA_API_KEY, DADATA_FIND_URL\nfrom http_client import get_session\nfrom party_state import format_company_state\n\nlogger = logging.getLogger(__name__)\n\n# –ß—Ç–æ–±—ã —ç–∫–æ–Ω–æ–º–∏—Ç—å –ª–∏–º–∏—Ç—ã DaData: –∫—ç—à –æ—Ç–≤–µ—Ç–æ–≤ –Ω–∞ 30 –º–∏–Ω—É—Ç.\n_PARTY_CACHE = TTLCache(ttl_seconds=30 * 60, max_items=5000)\n_BRANCHES_CACHE = TTLCache(ttl_seconds=30 * 60, max_items=2000)\n_DADATA_SEM = asyncio.Semaphore(5)\n\ndef _cache_key(query: str, branch_type: str | None = None) -> str:\n    return f"{query}:{branch_type or 'ALL'}"\n\n\nasync def fetch_companies(query: str, branch_type: str | None = None, count: int = 20) -> list[dict]:\n    """–ó–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –∫–æ–º–ø–∞–Ω–∏–π/—Ñ–∏–ª–∏–∞–ª–æ–≤ –ø–æ –ò–ù–ù/–û–ì–†–ù —á–µ—Ä–µ–∑ DaData API."""\n    cache_key = _cache_key(query, branch_type)\n    # –ö–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –∫—ç—à –¥–ª—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ–∏—Å–∫–∞ –∫–æ–º–ø–∞–Ω–∏–π ‚Äî _PARTY_CACHE\n    cached = _PARTY_CACHE.get(cache_key)\n    if cached is not None:\n        return cached\n\n    headers = {\n        "Content-Type": "application/json",\n        "Accept": "application/json",\n        "Authorization": f"Token {DADATA_API_KEY}",\n    }\n    payload: dict[str, str | int] = {"query": query, "count": max(1, min(count, 300))}\n    if branch_type:\n        payload["branch_type"] = branch_type\n\n    try:\n        async with _DADATA_SEM:\n            session = get_session()\n            async with session.post(DADATA_FIND_URL, json=payload, headers=headers) as resp:\n                if resp.status != 200:\n                    body = await resp.text()\n                    logger.error("DaData HTTP %s: %s", resp.status, body[:500])\n                    return []\n                data = await resp.json()\n    except Exception as exc:\n        logger.exception("–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –∫ DaData: %s", exc)\n        return []\n\n    suggestions = data.get("suggestions", []) or []\n    # –ó–∞–ø–∏—Å—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ –∫–æ–º–ø–∞–Ω–∏–π –≤ _PARTY_CACHE\n    _PARTY_CACHE.set(cache_key, suggestions)\n    return suggestions\n\n\nasync def fetch_company(query: str) -> dict | None:\n    """–ó–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –æ–¥–Ω—É –∫–æ–º–ø–∞–Ω–∏—é –ø–æ –ò–ù–ù/–û–ì–†–ù —á–µ—Ä–µ–∑ DaData API.\n\n    –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç —Ç–æ–ª—å–∫–æ –≥–æ–ª–æ–≤–Ω—É—é –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—é (branch_type=MAIN),\n    —á—Ç–æ–±—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å—Ä–∞–∑—É –ø–æ–ª—É—á–∞–ª –æ–¥–Ω—É –∫–∞—Ä—Ç–æ—á–∫—É.\n    """\n    cached = _PARTY_CACHE.get(query)\n    if cached is not None:\n        return cached\n\n    suggestions = await fetch_companies(query=query, branch_type="MAIN", count=1)\n    item = suggestions[0] if suggestions else None\n    _PARTY_CACHE.set(query, item)\n    return item\n\n\nasync def fetch_branches(query: str, count: int = 20) -> list[dict]:\n    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ñ–∏–ª–∏–∞–ª—ã –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ –ø–æ –ò–ù–ù/–û–ì–†–ù."""\n    return await fetch_companies(query=query, branch_type="BRANCH", count=count)\n\ndef _v(val: str | None, default: str = "‚Äî") -> str:\n    """–í–µ—Ä–Ω—É—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ –∏–ª–∏ –ø—Ä–æ—á–µ—Ä–∫ (–±–µ–∑–æ–ø–∞—Å–Ω–æ –¥–ª—è HTML)."""\n    if val is None or str(val).strip() == "":\n        return default\n    return html.escape(str(val).strip())\n\ndef _format_date(timestamp_ms: int | None) -> str | None:\n    if not timestamp_ms:\n        return None\n    try:\n        return datetime.fromtimestamp(timestamp_ms / 1000).strftime("%d.%m.%Y")\n    except Exception:\n        return None\n\ndef _format_money(value: int | float | None, year: int | None = None) -> str:\n    if value is None:\n        return "‚Äî"\n    if year:\n        return f"{value:,.0f} ‚ÇΩ ({year})".replace(",", " ")\n    return f"{value:,.0f} ‚ÇΩ".replace(",", " ")\n\ndef _entity_type_label(entity_type: str | None) -> str:\n    if entity_type == "INDIVIDUAL":\n        return "–ò–ü"\n    return "–Æ—Ä–∏–¥–∏—á–µ—Å–∫–æ–µ –ª–∏—Ü–æ"\n\ndef format_company_short_card(item: dict) -> str:\n    """–ö–æ—Ä–æ—Ç–∫–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞ –¥–ª—è –ø–µ—Ä–≤–æ–≥–æ —ç–∫—Ä–∞–Ω–∞ –º–µ–Ω–µ–¥–∂–µ—Ä—É."""\n    d = item.get("data", {})\n    name_short = _v(d.get("name", {}).get("short_with_opf") or item.get("value"))\n    inn = _v(d.get("inn"))\n    ogrn = _v(d.get("ogrn"))\n    kpp = _v(d.get("kpp"))\n\n    state = d.get("state", {})\n    status = _v(state.get("status"))\n\n    address_obj = d.get("address", {})\n    address = _v(address_obj.get("value") or address_obj.get("unrestricted_value"))\n\n    mgmt = d.get("management", {})\n    manager_name = _v(mgmt.get("name"))\n    manager_post = _v(mgmt.get("post"))\n\n    okved = _v(d.get("okved"))\n    employee_count = _v(d.get("employee_count"))\n\n    finance = d.get("finance", {})\n    revenue = _format_money(finance.get("revenue"), finance.get("year"))\n\n    return "\n".join(\n        [\n            f"<b>üìã {name_short}</b>",\n            f"<b>–ò–ù–ù:</b> <code>{inn}</code>  <b>–û–ì–†–ù:</b> <code>{ogrn}</code>  <b>–ö–ü–ü:</b> <code>{kpp}</code>",\n            f"<b>–°—Ç–∞—Ç—É—Å:</b> {status}",\n            f"<b>–ê–¥—Ä–µ—Å:</b> {address}",\n            f"<b>–†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å:</b> {manager_name} ({manager_post})",\n            f"<b>–û–ö–í–≠–î:</b> <code>{okved}</code>",\n            f"<b>–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏:</b> {employee_count}",\n            f"<b>–í—ã—Ä—É—á–∫–∞:</b> {revenue}",\n        ]\n    )\n\ndef format_company_details(item: dict) -> str:\n    """–§–æ—Ä–º–∏—Ä—É–µ—Ç —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—É—é HTML-–∫–∞—Ä—Ç–æ—á–∫—É –∫–æ–º–ø–∞–Ω–∏–∏ –¥–ª—è Telegram."""\n    d = item.get("data", {})\n    name_full = _v(d.get("name", {}).get("full_with_opf"))\n    name_short = _v(d.get("name", {}).get("short_with_opf"))\n    inn = _v(d.get("inn"))\n    kpp = _v(d.get("kpp"))\n    ogrn = _v(d.get("ogrn"))\n    okpo = _v(d.get("okpo"))\n    oktmo = _v(d.get("oktmo"))\n    okato = _v(d.get("okato"))\n\n    address_obj = d.get("address", {})\n    address = _v(address_obj.get("unrestricted_value") or address_obj.get("value"))\n\n    mgmt = d.get("management", {})\n    manager_name = _v(mgmt.get("name"))\n    manager_post = _v(mgmt.get("post"))\n\n    capital = d.get("capital", {})\n    cap_value = capital.get("value")\n    cap_type = _v(capital.get("type"), default="")\n    capital_str = _format_money(cap_value)\n    if cap_value is not None and cap_type:\n        capital_str += f" ({cap_type})"\n\n    okved = _v(d.get("okved"))\n    okved_type = _v(d.get("okved_type"))\n\n    phones_raw = d.get("phones") or []\n    phones = _v(", ".join(p.get("value", "") for p in phones_raw if p.get("value")), default="‚Äî")\n    emails_raw = d.get("emails") or []\n    emails = _v(", ".join(e.get("value", "") for e in emails_raw if e.get("value")), default="‚Äî")\n\n    entity_type = d.get("type")\n    state = d.get("state", {})\n    status = _v(format_company_state(state, entity_type))\n\n    reg_date = _format_date(state.get("registration_date")) or "‚Äî"\n    liq_date = _format_date(state.get("liquidation_date"))\n\n    branch_type = d.get("branch_type")\n    branch_count = d.get("branch_count")\n    if branch_type == "MAIN" and branch_count:\n        branches_str = f"–ì–æ–ª–æ–≤–Ω–∞—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è, —Ñ–∏–ª–∏–∞–ª–æ–≤: {branch_count}"\n    elif branch_type == "BRANCH":\n        branches_str = "–§–∏–ª–∏–∞–ª"\n    else:\n        branches_str = "‚Äî"\n\n    type_label = _entity_type_label(entity_type)\n\n    lines = [\n        f"<b>üìã {name_short}</b>",\n        "",\n        f"<b>–ü–æ–ª–Ω–æ–µ –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ:</b> {name_full}",\n        f"<b>–¢–∏–ø:</b> {type_label}",\n        f"<b>–°—Ç–∞—Ç—É—Å:</b> {status}",\n        f"<b>–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:</b> {reg_date}",\n    ]\n    if liq_date:\n        lines.append(f"<b>–î–∞—Ç–∞ –ª–∏–∫–≤–∏–¥–∞—Ü–∏–∏:</b> {liq_date}")\n\n    lines += [\n        "",\n        "<b>‚îÅ‚îÅ‚îÅ –†–µ–∫–≤–∏–∑–∏—Ç—ã ‚îÅ‚îÅ‚îÅ</b>",\n        f"<b>–ò–ù–ù:</b> <code>{inn}</code>",\n        f"<b>–ö–ü–ü:</b> <code>{kpp}</code>",\n        f"<b>–û–ì–†–ù:</b> <code>{ogrn}</code>",\n        f"<b>–û–ö–ü–û:</b> <code>{okpo}</code>",\n        f"<b>–û–ö–¢–ú–û:</b> <code>{oktmo}</code>",\n        f"<b>–û–ö–ê–¢–û:</b> <code>{okato}</code>",\n        "",\n        "<b>‚îÅ‚îÅ‚îÅ –ê–¥—Ä–µ—Å ‚îÅ‚îÅ‚îÅ</b>",\n        f"{address}",\n        "",\n        "<b>‚îÅ‚îÅ‚îÅ –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ ‚îÅ‚îÅ‚îÅ</b>",\n        f"<b>–î–æ–ª–∂–Ω–æ—Å—Ç—å:</b> {manager_post}",\n        f"<b>–§–ò–û:</b> {manager_name}",\n        "",\n        "<b>‚îÅ‚îÅ‚îÅ –§–∏–Ω–∞–Ω—Å—ã ‚îÅ‚îÅ‚îÅ</b>",\n        f"<b>–£—Å—Ç–∞–≤–Ω—ã–π –∫–∞–ø–∏—Ç–∞–ª:</b> {capital_str}",\n        "",\n        "<b>‚îÅ‚îÅ‚îÅ –î–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç—å ‚îÅ‚îÅ‚îÅ</b>",\n        f"<b>–û–ö–í–≠–î:</b> {okved} (–≤–µ—Ä—Å–∏—è {okved_type})",\n        "",\n        "<b>‚îÅ‚îÅ‚îÅ –ö–æ–Ω—Ç–∞–∫—Ç—ã ‚îÅ‚îÅ‚îÅ</b>",\n        f"<b>–¢–µ–ª–µ—Ñ–æ–Ω—ã:</b> {phones}",\n        f"<b>Email:</b> {emails}",\n        "",\n        "<b>‚îÅ‚îÅ‚îÅ –§–∏–ª–∏–∞–ª—ã ‚îÅ‚îÅ‚îÅ</b>",\n        f"{_v(branches_str)}",\n    ]\n\n    return "\n".join(lines)\n\ndef format_company_requisites(item: dict) -> str:\n    """–¢–µ–∫—Å—Ç –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è —Ä–µ–∫–≤–∏–∑–∏—Ç–æ–≤ –≤ CRM."""\n    d = item.get("data", {})\n    name_full = _v(d.get("name", {}).get("full_with_opf"))\n    inn = _v(d.get("inn"))\n    kpp = _v(d.get("kpp"))\n    ogrn = _v(d.get("ogrn"))\n    address = _v((d.get("address") or {}).get("unrestricted_value"))\n\n    return "\n".join(\n        [\n            "–†–µ–∫–≤–∏–∑–∏—Ç—ã –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–∞:",\n            f"–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ: {name_full}",\n            f"–ò–ù–ù: {inn}",\n            f"–ö–ü–ü: {kpp}",\n            f"–û–ì–†–ù: {ogrn}",\n            f"–Æ—Ä–∏–¥–∏—á–µ—Å–∫–∏–π –∞–¥—Ä–µ—Å: {address}",\n        ]\n    )\n\ndef format_branches_list(items: list[dict]) -> str:\n    """–°–ø–∏—Å–æ–∫ —Ñ–∏–ª–∏–∞–ª–æ–≤ –≤ –∫–æ–º–ø–∞–∫—Ç–Ω–æ–º –≤–∏–¥–µ."""\n    if not items:\n        return "–§–∏–ª–∏–∞–ª—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã."\n\n    lines = ["<b>üè¢ –§–∏–ª–∏–∞–ª—ã</b>"]\n    for idx, item in enumerate(items, start=1):\n        d = item.get("data", {})\n        name = _v(d.get("name", {}).get("short_with_opf") or item.get("value"))\n        kpp = _v(d.get("kpp"))\n        address = _v((d.get("address") or {}).get("value"))\n        lines.append(f"{idx}. {name}")\n        lines.append(f"   –ö–ü–ü: <code>{kpp}</code>")\n        lines.append(f"   –ê–¥—Ä–µ—Å: {address}")\n\n    return "\n".join(lines)\n